<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-12-25">

<title>Sales Data Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="dynamic_regression_pipeline_files/libs/clipboard/clipboard.min.js"></script>
<script src="dynamic_regression_pipeline_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="dynamic_regression_pipeline_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="dynamic_regression_pipeline_files/libs/quarto-html/popper.min.js"></script>
<script src="dynamic_regression_pipeline_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="dynamic_regression_pipeline_files/libs/quarto-html/anchor.min.js"></script>
<link href="dynamic_regression_pipeline_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="dynamic_regression_pipeline_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="dynamic_regression_pipeline_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="dynamic_regression_pipeline_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="dynamic_regression_pipeline_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Sales Data Analysis</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 25, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="load-data" class="level2">
<h2 class="anchored" data-anchor-id="load-data">1. Load Data</h2>
<p>We use <code>read_csv</code> for parsing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fpp3)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>sales_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/sales_train_validation_afcs2025.csv"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>calendar_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/calendar_afcs2025.csv"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>prices_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/sell_prices_afcs2025.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="process-calendar" class="level2">
<h2 class="anchored" data-anchor-id="process-calendar">2. Process Calendar</h2>
<p>The user assumes <code>d_1</code> corresponds to 2011-01-29. We ensure the calendar dates are parsed correctly. We also create a ‘d’ column to match with sales columns (<code>d_1</code>, <code>d_2</code>, …).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>calendar <span class="ot">&lt;-</span> calendar_raw <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">mdy</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a 'd' column to match with sales columns (d_1, d_2, ...)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">d =</span> <span class="fu">paste0</span>(<span class="st">"d_"</span>, <span class="fu">row_number</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="identify-unique-events" class="level3">
<h3 class="anchored" data-anchor-id="identify-unique-events">Identify unique events</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>event_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">unique</span>(calendar_raw<span class="sc">$</span>event_name_1), <span class="fu">unique</span>(calendar_raw<span class="sc">$</span>event_name_2))</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>event_types <span class="ot">&lt;-</span> event_types[<span class="sc">!</span><span class="fu">is.na</span>(event_types)]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>event_types <span class="ot">&lt;-</span> <span class="fu">unique</span>(event_types)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="checking-for-any-inconsistencies" class="level3">
<h3 class="anchored" data-anchor-id="checking-for-any-inconsistencies">Checking for any inconsistencies</h3>
<p>The user asked to check for changes in spaces or lowercase/uppercase. We can normalize them to lower case and check if we have fewer unique values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>normalized_events <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">str_replace_all</span>(event_types, <span class="st">"[^[:alnum:]]"</span>, <span class="st">""</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(<span class="fu">unique</span>(normalized_events)) <span class="sc">&lt;</span> <span class="fu">length</span>(event_types)) {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="st">"Same events found with different casing or formatting. Please inspect."</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="create-event-columns" class="level3">
<h3 class="anchored" data-anchor-id="create-event-columns">Create Event Columns</h3>
<p>Ensure calendar is sorted by date for <code>lead()</code> to work correctly. Create binary columns for each event. Logic: 1 if event matches <code>event_name_1</code> OR <code>event_name_2</code>, OR if it is one of the 3 days BEFORE the event (using lead checks on future dates).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure calendar is sorted by date for lead() to work correctly</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>calendar <span class="ot">&lt;-</span> calendar <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(date)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create binary columns for each event</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(evt <span class="cf">in</span> event_types) {</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a clean column name (remove spaces and special chars)</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  col_name <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(evt, <span class="st">"[^[:alnum:]]"</span>, <span class="st">""</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># temporary helper to identify the specific event date</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  calendar <span class="ot">&lt;-</span> calendar <span class="sc">%&gt;%</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">is_event_today =</span> <span class="fu">coalesce</span>(event_name_1 <span class="sc">==</span> evt, <span class="cn">FALSE</span>) <span class="sc">|</span> <span class="fu">coalesce</span>(event_name_2 <span class="sc">==</span> evt, <span class="cn">FALSE</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply specific logic for Christmas vs. other events</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (evt <span class="sc">==</span> <span class="st">"Christmas"</span>) {</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    calendar <span class="ot">&lt;-</span> calendar <span class="sc">%&gt;%</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Column 1: JUST Christmas Day</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!!</span><span class="fu">paste0</span>(col_name, <span class="st">"Day"</span>) <span class="sc">:</span><span class="er">=</span> <span class="fu">as.integer</span>(is_event_today),</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Column 2: JUST the 3 days before Christmas</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!!</span><span class="fu">paste0</span>(col_name, <span class="st">"Pre"</span>) <span class="sc">:</span><span class="er">=</span> <span class="fu">as.integer</span>(</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>          <span class="fu">lead</span>(is_event_today, <span class="dv">1</span>, <span class="at">default =</span> <span class="cn">FALSE</span>) <span class="sc">|</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">lead</span>(is_event_today, <span class="dv">2</span>, <span class="at">default =</span> <span class="cn">FALSE</span>) <span class="sc">|</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>          <span class="fu">lead</span>(is_event_today, <span class="dv">3</span>, <span class="at">default =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    calendar <span class="ot">&lt;-</span> calendar <span class="sc">%&gt;%</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Standard Logic: Combine Day + 3 Days Before</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!!</span><span class="at">col_name :=</span> <span class="fu">as.integer</span>(</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>          is_event_today <span class="sc">|</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>          <span class="fu">lead</span>(is_event_today, <span class="dv">1</span>, <span class="at">default =</span> <span class="cn">FALSE</span>) <span class="sc">|</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>          <span class="fu">lead</span>(is_event_today, <span class="dv">2</span>, <span class="at">default =</span> <span class="cn">FALSE</span>) <span class="sc">|</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>          <span class="fu">lead</span>(is_event_today, <span class="dv">3</span>, <span class="at">default =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up temporary column</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  calendar <span class="ot">&lt;-</span> calendar <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>is_event_today)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="process-sales-data" class="level2">
<h2 class="anchored" data-anchor-id="process-sales-data">3. Process Sales Data</h2>
<p>Pivot from wide to long format to create a time series structure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>sales_long <span class="ot">&lt;-</span> sales_raw <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"d_"</span>),</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"d"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"sales_volume"</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="extract-item-and-store-ids-from-the-id-column" class="level2">
<h2 class="anchored" data-anchor-id="extract-item-and-store-ids-from-the-id-column">4. Extract Item and Store IDs from the ‘id’ column</h2>
<p>Instruction: “CORRECT ITEMID (which can be isolated from the first 11 digits of the id column…)” We also need <code>store_id</code> to join with prices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>sales_long <span class="ot">&lt;-</span> sales_long <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract first 11 characters for item_id</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">item_id =</span> <span class="fu">str_sub</span>(id, <span class="dv">1</span>, <span class="dv">11</span>),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract store_id. </span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Logic: The id is typically {item_id}_{store_id}_validation</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We take the substring after the item_id (from char 13) and remove '_validation'</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">store_id_temp =</span> <span class="fu">str_sub</span>(id, <span class="dv">13</span>, <span class="fu">nchar</span>(id)),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">store_id =</span> <span class="fu">str_remove</span>(store_id_temp, <span class="st">"_validation"</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>store_id_temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="merge-with-calendar-information" class="level2">
<h2 class="anchored" data-anchor-id="merge-with-calendar-information">5. Merge with Calendar Information</h2>
<p>Join by ‘d’ identifier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>sales_with_calendar <span class="ot">&lt;-</span> sales_long <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calendar, <span class="at">by =</span> <span class="st">"d"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="merge-with-sell-prices" class="level2">
<h2 class="anchored" data-anchor-id="merge-with-sell-prices">6. Merge with Sell Prices</h2>
<p>Join using <code>wm_yr_wk</code>, <code>store_id</code>, and <code>item_id</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>final_data <span class="ot">&lt;-</span> sales_with_calendar <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(prices_raw, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"store_id"</span>, <span class="st">"item_id"</span>, <span class="st">"wm_yr_wk"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="convert-to-tsibble" class="level2">
<h2 class="anchored" data-anchor-id="convert-to-tsibble">7. Convert to tsibble</h2>
<p>The output should be one tsibble containing day-granularity time series. We use <code>id</code> as the key to distinguish each product time series. We use <code>date</code> as the time index.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>product_tsibble <span class="ot">&lt;-</span> final_data <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure date is sorted (tsibble expects sorted index usually, though as_tsibble handles it)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, date) <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">key =</span> id, <span class="at">index =</span> date)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Cleanup large intermediate objects to free memory</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(sales_raw, calendar_raw, prices_raw, sales_long, sales_with_calendar, final_data)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           used  (Mb) gc trigger   (Mb) limit (Mb)  max used   (Mb)
Ncells  1500742  80.2    2660138  142.1         NA   2660138  142.1
Vcells 54649367 417.0  206008805 1571.8      65536 236552781 1804.8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the final tsibble</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>product_tsibble</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tsibble: 1,574,399 x 48 [1D]
# Key:       id [823]
   id      d     sales_volume item_id store_id date       wm_yr_wk weekday  wday
   &lt;chr&gt;   &lt;chr&gt;        &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;date&gt;        &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;
 1 FOODS_… d_1              0 FOODS_… TX_3     2011-01-29    11101 Saturd…     1
 2 FOODS_… d_2              2 FOODS_… TX_3     2011-01-30    11101 Sunday      2
 3 FOODS_… d_3              1 FOODS_… TX_3     2011-01-31    11101 Monday      3
 4 FOODS_… d_4              3 FOODS_… TX_3     2011-02-01    11101 Tuesday     4
 5 FOODS_… d_5              0 FOODS_… TX_3     2011-02-02    11101 Wednes…     5
 6 FOODS_… d_6              0 FOODS_… TX_3     2011-02-03    11101 Thursd…     6
 7 FOODS_… d_7              1 FOODS_… TX_3     2011-02-04    11101 Friday      7
 8 FOODS_… d_8              0 FOODS_… TX_3     2011-02-05    11102 Saturd…     1
 9 FOODS_… d_9              2 FOODS_… TX_3     2011-02-06    11102 Sunday      2
10 FOODS_… d_10             1 FOODS_… TX_3     2011-02-07    11102 Monday      3
# ℹ 1,574,389 more rows
# ℹ 39 more variables: month &lt;dbl&gt;, year &lt;dbl&gt;, event_name_1 &lt;chr&gt;,
#   event_type_1 &lt;chr&gt;, event_name_2 &lt;chr&gt;, event_type_2 &lt;chr&gt;, snap_TX &lt;dbl&gt;,
#   SuperBowl &lt;int&gt;, ValentinesDay &lt;int&gt;, PresidentsDay &lt;int&gt;, LentStart &lt;int&gt;,
#   LentWeek2 &lt;int&gt;, StPatricksDay &lt;int&gt;, PurimEnd &lt;int&gt;, OrthodoxEaster &lt;int&gt;,
#   PesachEnd &lt;int&gt;, CincoDeMayo &lt;int&gt;, Mothersday &lt;int&gt;, MemorialDay &lt;int&gt;,
#   NBAFinalsStart &lt;int&gt;, NBAFinalsEnd &lt;int&gt;, Fathersday &lt;int&gt;, …</code></pre>
</div>
</div>
</section>
<section id="visualization" class="level2">
<h2 class="anchored" data-anchor-id="visualization">8. Visualization</h2>
<p>The following graph displays the sum of product sales over the full available time window.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork) <span class="co"># Required for arranging plots side-by-side</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Daily Aggregation &amp; Analysis</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>daily_sales <span class="ot">&lt;-</span> product_tsibble <span class="sc">%&gt;%</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">index_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(sales_volume, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot: Daily Sales Over Time</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>daily_sales <span class="sc">%&gt;%</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(total_sales) <span class="sc">+</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total Daily Sales Volume Over Time"</span>,</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Sum of Sales"</span>,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dynamic_regression_pipeline_files/figure-html/plot_sales_analysis-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot: Daily ACF and PACF (14 lags / 2 weeks)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>p1_daily <span class="ot">&lt;-</span> daily_sales <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ACF</span>(total_sales, <span class="at">lag_max =</span> <span class="dv">14</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Daily ACF (14 Lags)"</span>) <span class="sc">+</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>p2_daily <span class="ot">&lt;-</span> daily_sales <span class="sc">%&gt;%</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PACF</span>(total_sales, <span class="at">lag_max =</span> <span class="dv">14</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Daily PACF (14 Lags)"</span>) <span class="sc">+</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Display side-by-side</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>p1_daily <span class="sc">+</span> p2_daily</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dynamic_regression_pipeline_files/figure-html/plot_sales_analysis-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Weekly Aggregation &amp; Analysis</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>weekly_sales <span class="ot">&lt;-</span> daily_sales <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">index_by</span>(<span class="at">week =</span> <span class="fu">yearweek</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(total_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot: Weekly Sums</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>weekly_sales <span class="sc">%&gt;%</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(total_sales) <span class="sc">+</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total Weekly Sales Volume"</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Weekly Sum of Sales"</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Week"</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dynamic_regression_pipeline_files/figure-html/plot_sales_analysis-3.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot: Weekly ACF and PACF (8 lags / 2 months)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>p1_weekly <span class="ot">&lt;-</span> weekly_sales <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ACF</span>(total_sales, <span class="at">lag_max =</span> <span class="dv">8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Weekly ACF (8 Lags)"</span>) <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>p2_weekly <span class="ot">&lt;-</span> weekly_sales <span class="sc">%&gt;%</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PACF</span>(total_sales, <span class="at">lag_max =</span> <span class="dv">8</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Weekly PACF (8 Lags)"</span>) <span class="sc">+</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>p1_weekly <span class="sc">+</span> p2_weekly</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dynamic_regression_pipeline_files/figure-html/plot_sales_analysis-4.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Monthly Aggregation &amp; Analysis</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>monthly_sales <span class="ot">&lt;-</span> daily_sales <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">index_by</span>(<span class="at">month =</span> <span class="fu">yearmonth</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(total_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot: Monthly Sums</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>monthly_sales <span class="sc">%&gt;%</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(total_sales) <span class="sc">+</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total Monthly Sales Volume"</span>,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Monthly Sum of Sales"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Month"</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dynamic_regression_pipeline_files/figure-html/plot_sales_analysis-5.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot: Monthly ACF and PACF (24 lags / 2 years)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>p1_monthly <span class="ot">&lt;-</span> monthly_sales <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ACF</span>(total_sales, <span class="at">lag_max =</span> <span class="dv">24</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Monthly ACF (24 Lags)"</span>) <span class="sc">+</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>p2_monthly <span class="ot">&lt;-</span> monthly_sales <span class="sc">%&gt;%</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PACF</span>(total_sales, <span class="at">lag_max =</span> <span class="dv">24</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Monthly PACF (24 Lags)"</span>) <span class="sc">+</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>p1_monthly <span class="sc">+</span> p2_monthly</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dynamic_regression_pipeline_files/figure-html/plot_sales_analysis-6.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="predictor-selection-and-exploratory-analysis" class="level2">
<h2 class="anchored" data-anchor-id="predictor-selection-and-exploratory-analysis">9. Predictor Selection and Exploratory Analysis</h2>
<p>According to FPP3 Chapter 7, the first step in building a regression model is ensuring our predictors have a relationship with the forecast variable. Since we have thousands of products, performing this diagnosis on every single time series individually is impractical. Instead, we either select representative products to explore the efficacy of our potential predictors or compare the predictors to the sum total sales across products. We inspect the relationship between Sales Volume and Price. Economic theory suggests a negative correlation (as price goes up, sales go down), but we should verify this in the data. We select a random sample of <strong>10 products</strong> to explore the relationship between Sales Volume and Price across this sample. Economic theory suggests a negative correlation (as price goes up, sales go down), and we verify this pattern across multiple items below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Select 10 random products</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># Set seed for reproducibility</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>all_ids <span class="ot">&lt;-</span> <span class="fu">unique</span>(product_tsibble<span class="sc">$</span>id)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>sample_ids <span class="ot">&lt;-</span> <span class="fu">sample</span>(all_ids, <span class="dv">10</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Define a helper function to plot "Sales vs Price" for a given ID</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>plot_price_vs_sales <span class="ot">&lt;-</span> <span class="cf">function</span>(target_id) {</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  product_tsibble <span class="sc">%&gt;%</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(id <span class="sc">==</span> target_id) <span class="sc">%&gt;%</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> sell_price, <span class="at">y =</span> sales_volume)) <span class="sc">+</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Item:"</span>, target_id),</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Sell Price"</span>, </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Sales Volume"</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Generate plots for all 10 IDs</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>plot_list <span class="ot">&lt;-</span> <span class="fu">map</span>(sample_ids, plot_price_vs_sales)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Arrange in a grid: 5 rows, 2 columns</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(plot_list, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dynamic_regression_pipeline_files/figure-html/sample_10_products-1.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
</div>
<p>Next, we look at Categorical Predictors like snap_TX and events:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate total sales per day</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>daily_sales_agg <span class="ot">&lt;-</span> product_tsibble <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">index_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(sales_volume, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join with calendar to get the snap_TX column</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calendar, <span class="at">by =</span> <span class="st">"date"</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create comparative boxplot</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>daily_sales_agg <span class="sc">%&gt;%</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">snap_TX =</span> <span class="fu">factor</span>(snap_TX, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"No SNAP"</span>, <span class="st">"SNAP Active"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> snap_TX, <span class="at">y =</span> total_sales, <span class="at">fill =</span> snap_TX)) <span class="sc">+</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Total Sales Distribution: SNAP vs Non-SNAP Days"</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Is SNAP Active?"</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total Daily Sales Volume"</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dynamic_regression_pipeline_files/figure-html/plot_snap_comparison-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Aggregate to Daily Global Sales</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>daily_sales_agg <span class="ot">&lt;-</span> product_tsibble <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">index_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(sales_volume, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Join with Calendar to retrieve Event Flags</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co"># We join the daily sales with the calendar to access the binary event columns created earlier.</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>analysis_data <span class="ot">&lt;-</span> daily_sales_agg <span class="sc">%&gt;%</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calendar, <span class="at">by =</span> <span class="st">"date"</span>)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Define the list of events to analyze (as requested)</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co"># We list them in lowercase to match case-insensitively against the actual columns.</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>target_events_list <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"superbowl"</span>, <span class="st">"valentinesday"</span>, <span class="st">"presidentsday"</span>, <span class="st">"lentstart"</span>, <span class="st">"lentweek2"</span>, </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"stpatricksday"</span>, <span class="st">"purimend"</span>, <span class="st">"orthodoxeaster"</span>, <span class="st">"pesachend"</span>, <span class="st">"cincodemayo"</span>, </span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"mothersday"</span>, <span class="st">"memorialday"</span>, <span class="st">"nbafinalsstart"</span>, <span class="st">"nbafinalsend"</span>, <span class="st">"fathersday"</span>, </span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"independenceday"</span>, <span class="st">"ramadanstarts"</span>, <span class="st">"eidalfitr"</span>, <span class="st">"laborday"</span>, <span class="st">"columbusday"</span>, </span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"halloween"</span>, <span class="st">"eidaladha"</span>, <span class="st">"veteransday"</span>, <span class="st">"thanksgiving"</span>, <span class="st">"christmasday"</span>, <span class="st">"christmaspre"</span>, </span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"chanukahend"</span>, <span class="st">"newyear"</span>, <span class="st">"orthodoxchristmas"</span>, <span class="st">"martinlutherkingday"</span>, <span class="st">"easter"</span>,</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"snap_TX"</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Process Data for Plotting</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> analysis_data <span class="sc">%&gt;%</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Select date, sales, and columns that match our target list (ignoring case)</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, total_sales, <span class="fu">matches</span>(<span class="fu">paste0</span>(<span class="st">"^("</span>, <span class="fu">paste</span>(target_events_list, <span class="at">collapse=</span><span class="st">"|"</span>), <span class="st">")$"</span>), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pivot longer to stack all events into two columns: 'event_name' and 'is_active'</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span><span class="fu">c</span>(date, total_sales), </span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"event_name"</span>, </span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"is_active"</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert 1/0 to meaningful Factors ("Yes"/"No")</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_active =</span> <span class="fu">factor</span>(is_active, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"No"</span>, <span class="st">"Yes"</span>)),</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format labels to "CamelCase" / Title Case for better readability</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_label =</span> <span class="fu">str_to_title</span>(event_name),</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Manual fix for 'snap_TX' if str_to_title messes it up (optional polish)</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_label =</span> <span class="fu">ifelse</span>(event_name <span class="sc">==</span> <span class="st">"snap_TX"</span>, <span class="st">"Snap TX"</span>, event_label)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Generate Boxplots</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>plot_data <span class="sc">%&gt;%</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> is_active, <span class="at">y =</span> total_sales, <span class="at">fill =</span> is_active)) <span class="sc">+</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.alpha =</span> <span class="fl">0.3</span>, <span class="at">outlier.size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Facet wrap creates the "numerous box plots" layout</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> event_label, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">5</span>) <span class="sc">+</span> </span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Impact of Events on Total Daily Sales Volume"</span>,</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparison of Daily Sales: Days with Event (Yes) vs. Days without (No)"</span>,</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Is Event Active?"</span>,</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Total Daily Sales Volume"</span></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dynamic_regression_pipeline_files/figure-html/plot_event_impact-1.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Aggregate to Daily Global Sales</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>daily_sales_agg <span class="ot">&lt;-</span> product_tsibble <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">index_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(sales_volume, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calendar, <span class="at">by =</span> <span class="st">"date"</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Define the list of events to analyze</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>target_events_list <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"superbowl"</span>, <span class="st">"valentinesday"</span>, <span class="st">"presidentsday"</span>, <span class="st">"lentstart"</span>, <span class="st">"lentweek2"</span>, </span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"stpatricksday"</span>, <span class="st">"purimend"</span>, <span class="st">"orthodoxeaster"</span>, <span class="st">"pesachend"</span>, <span class="st">"cincodemayo"</span>, </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"mothersday"</span>, <span class="st">"memorialday"</span>, <span class="st">"nbafinalsstart"</span>, <span class="st">"nbafinalsend"</span>, <span class="st">"fathersday"</span>, </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"independenceday"</span>, <span class="st">"ramadanstarts"</span>, <span class="st">"eidalfitr"</span>, <span class="st">"laborday"</span>, <span class="st">"columbusday"</span>, </span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"halloween"</span>, <span class="st">"eidaladha"</span>, <span class="st">"veteransday"</span>, <span class="st">"thanksgiving"</span>, <span class="st">"christmas"</span>, </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"chanukahend"</span>, <span class="st">"newyear"</span>, <span class="st">"orthodoxchristmas"</span>, <span class="st">"martinlutherkingday"</span>, <span class="st">"easter"</span>,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"snap_TX"</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Compute Averages and Differences</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>impact_table <span class="ot">&lt;-</span> daily_sales_agg <span class="sc">%&gt;%</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># IMPORTANT: Convert to a standard tibble to drop the date index during summarise</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(total_sales, <span class="fu">matches</span>(<span class="fu">paste0</span>(<span class="st">"^("</span>, <span class="fu">paste</span>(target_events_list, <span class="at">collapse=</span><span class="st">"|"</span>), <span class="st">")$"</span>), <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pivot to long format</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="sc">-</span>total_sales,</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"event_name"</span>,</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"is_active"</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Now this will group globally across all dates</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(event_name, is_active) <span class="sc">%&gt;%</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">avg_sales =</span> <span class="fu">mean</span>(total_sales, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Reshape to have columns for "No Event" (0) and "Event" (1)</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> is_active,</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> avg_sales,</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_prefix =</span> <span class="st">"active_"</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate the Difference</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_sales_without =</span> active_0,</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_sales_with =</span> active_1,</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">difference =</span> avg_sales_with <span class="sc">-</span> avg_sales_without</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(event_name, avg_sales_with, avg_sales_without, difference) <span class="sc">%&gt;%</span></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(difference))</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Display the Table</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Using knitr::kable for a clean table output in RMarkdown</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(impact_table, <span class="at">caption =</span> <span class="st">"Average Sales Impact by Event (Sorted by Positive Effect)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Average Sales Impact by Event (Sorted by Positive Effect)</caption>
<thead>
<tr class="header">
<th style="text-align: left;">event_name</th>
<th style="text-align: right;">avg_sales_with</th>
<th style="text-align: right;">avg_sales_without</th>
<th style="text-align: right;">difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">LaborDay</td>
<td style="text-align: right;">1933.050</td>
<td style="text-align: right;">1563.019</td>
<td style="text-align: right;">370.030983</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fathersday</td>
<td style="text-align: right;">1854.850</td>
<td style="text-align: right;">1563.845</td>
<td style="text-align: right;">291.004781</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IndependenceDay</td>
<td style="text-align: right;">1835.800</td>
<td style="text-align: right;">1564.046</td>
<td style="text-align: right;">271.753513</td>
</tr>
<tr class="even">
<td style="text-align: left;">ColumbusDay</td>
<td style="text-align: right;">1823.550</td>
<td style="text-align: right;">1564.176</td>
<td style="text-align: right;">259.374089</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Easter</td>
<td style="text-align: right;">1807.625</td>
<td style="text-align: right;">1563.829</td>
<td style="text-align: right;">243.795990</td>
</tr>
<tr class="even">
<td style="text-align: left;">NBAFinalsEnd</td>
<td style="text-align: right;">1792.000</td>
<td style="text-align: right;">1564.509</td>
<td style="text-align: right;">227.490755</td>
</tr>
<tr class="odd">
<td style="text-align: left;">EidalFitr</td>
<td style="text-align: right;">1784.250</td>
<td style="text-align: right;">1564.591</td>
<td style="text-align: right;">219.658875</td>
</tr>
<tr class="even">
<td style="text-align: left;">snap_TX</td>
<td style="text-align: right;">1699.157</td>
<td style="text-align: right;">1501.938</td>
<td style="text-align: right;">197.218717</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ramadanstarts</td>
<td style="text-align: right;">1676.900</td>
<td style="text-align: right;">1565.725</td>
<td style="text-align: right;">111.174696</td>
</tr>
<tr class="even">
<td style="text-align: left;">SuperBowl</td>
<td style="text-align: right;">1676.125</td>
<td style="text-align: right;">1565.500</td>
<td style="text-align: right;">110.625265</td>
</tr>
<tr class="odd">
<td style="text-align: left;">OrthodoxEaster</td>
<td style="text-align: right;">1659.400</td>
<td style="text-align: right;">1565.910</td>
<td style="text-align: right;">93.489805</td>
</tr>
<tr class="even">
<td style="text-align: left;">PresidentsDay</td>
<td style="text-align: right;">1658.958</td>
<td style="text-align: right;">1565.718</td>
<td style="text-align: right;">93.240493</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NBAFinalsStart</td>
<td style="text-align: right;">1641.050</td>
<td style="text-align: right;">1566.104</td>
<td style="text-align: right;">74.945932</td>
</tr>
<tr class="even">
<td style="text-align: left;">MemorialDay</td>
<td style="text-align: right;">1640.300</td>
<td style="text-align: right;">1566.112</td>
<td style="text-align: right;">74.188008</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Mothersday</td>
<td style="text-align: right;">1631.850</td>
<td style="text-align: right;">1566.201</td>
<td style="text-align: right;">65.648732</td>
</tr>
<tr class="even">
<td style="text-align: left;">ValentinesDay</td>
<td style="text-align: right;">1621.625</td>
<td style="text-align: right;">1566.192</td>
<td style="text-align: right;">55.432835</td>
</tr>
<tr class="odd">
<td style="text-align: left;">StPatricksDay</td>
<td style="text-align: right;">1615.875</td>
<td style="text-align: right;">1566.265</td>
<td style="text-align: right;">49.609780</td>
</tr>
<tr class="even">
<td style="text-align: left;">PesachEnd</td>
<td style="text-align: right;">1604.400</td>
<td style="text-align: right;">1566.491</td>
<td style="text-align: right;">37.908716</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MartinLutherKingDay</td>
<td style="text-align: right;">1593.800</td>
<td style="text-align: right;">1566.603</td>
<td style="text-align: right;">27.196725</td>
</tr>
<tr class="even">
<td style="text-align: left;">CincoDeMayo</td>
<td style="text-align: right;">1571.900</td>
<td style="text-align: right;">1566.835</td>
<td style="text-align: right;">5.065346</td>
</tr>
<tr class="odd">
<td style="text-align: left;">EidAlAdha</td>
<td style="text-align: right;">1566.550</td>
<td style="text-align: right;">1566.891</td>
<td style="text-align: right;">-0.341178</td>
</tr>
<tr class="even">
<td style="text-align: left;">OrthodoxChristmas</td>
<td style="text-align: right;">1548.950</td>
<td style="text-align: right;">1567.077</td>
<td style="text-align: right;">-18.127126</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LentWeek2</td>
<td style="text-align: right;">1543.583</td>
<td style="text-align: right;">1567.184</td>
<td style="text-align: right;">-23.600362</td>
</tr>
<tr class="even">
<td style="text-align: left;">VeteransDay</td>
<td style="text-align: right;">1540.650</td>
<td style="text-align: right;">1567.165</td>
<td style="text-align: right;">-26.514818</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PurimEnd</td>
<td style="text-align: right;">1530.875</td>
<td style="text-align: right;">1567.345</td>
<td style="text-align: right;">-36.470156</td>
</tr>
<tr class="even">
<td style="text-align: left;">Thanksgiving</td>
<td style="text-align: right;">1509.750</td>
<td style="text-align: right;">1567.491</td>
<td style="text-align: right;">-57.741284</td>
</tr>
<tr class="odd">
<td style="text-align: left;">LentStart</td>
<td style="text-align: right;">1493.875</td>
<td style="text-align: right;">1567.815</td>
<td style="text-align: right;">-73.940246</td>
</tr>
<tr class="even">
<td style="text-align: left;">NewYear</td>
<td style="text-align: right;">1428.200</td>
<td style="text-align: right;">1568.353</td>
<td style="text-align: right;">-140.152879</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ChanukahEnd</td>
<td style="text-align: right;">1409.750</td>
<td style="text-align: right;">1568.548</td>
<td style="text-align: right;">-158.797808</td>
</tr>
<tr class="even">
<td style="text-align: left;">Halloween</td>
<td style="text-align: right;">1311.650</td>
<td style="text-align: right;">1569.584</td>
<td style="text-align: right;">-257.934258</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Aggregate to Daily Global Sales &amp; Join Calendar</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------------------------</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>daily_sales_agg <span class="ot">&lt;-</span> product_tsibble <span class="sc">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">index_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_sales =</span> <span class="fu">sum</span>(sales_volume, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calendar, <span class="at">by =</span> <span class="st">"date"</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Define the list of events</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>target_events_list <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"superbowl"</span>, <span class="st">"valentinesday"</span>, <span class="st">"presidentsday"</span>, <span class="st">"lentstart"</span>, <span class="st">"lentweek2"</span>, </span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"stpatricksday"</span>, <span class="st">"purimend"</span>, <span class="st">"orthodoxeaster"</span>, <span class="st">"pesachend"</span>, <span class="st">"cincodemayo"</span>, </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"mothersday"</span>, <span class="st">"memorialday"</span>, <span class="st">"nbafinalsstart"</span>, <span class="st">"nbafinalsend"</span>, <span class="st">"fathersday"</span>, </span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"independenceday"</span>, <span class="st">"ramadanstarts"</span>, <span class="st">"eidalfitr"</span>, <span class="st">"laborday"</span>, <span class="st">"columbusday"</span>, </span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"halloween"</span>, <span class="st">"eidaladha"</span>, <span class="st">"veteransday"</span>, <span class="st">"thanksgiving"</span>, <span class="st">"christmasday"</span>, <span class="st">"christmaspre"</span>, </span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"chanukahend"</span>, <span class="st">"newyear"</span>, <span class="st">"orthodoxchristmas"</span>, <span class="st">"martinlutherkingday"</span>, <span class="st">"easter"</span>,</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"snap_TX"</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Perform T-Tests for each event</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co"># We iterate over each event name, find the matching column, and run a t-test.</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>hypothesis_results <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(target_events_list, <span class="cf">function</span>(evt_name) {</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify the actual column name in the dataframe (handling case insensitivity)</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We look for a column that matches the event name exactly (anchored)</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  col_match <span class="ot">&lt;-</span> <span class="fu">names</span>(daily_sales_agg)[<span class="fu">str_detect</span>(<span class="fu">names</span>(daily_sales_agg), <span class="fu">regex</span>(<span class="fu">paste0</span>(<span class="st">"^"</span>, evt_name, <span class="st">"$"</span>), <span class="at">ignore_case =</span> <span class="cn">TRUE</span>))]</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Safety check: if column not found or multiple matches, skip or pick first</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(col_match) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  col_name <span class="ot">&lt;-</span> col_match[<span class="dv">1</span>]</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract relevant data</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  test_data <span class="ot">&lt;-</span> daily_sales_agg <span class="sc">%&gt;%</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(total_sales, <span class="at">is_active =</span> <span class="sc">!!</span><span class="fu">sym</span>(col_name))</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure we have data for both groups (0 and 1)</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># A t-test will fail if one group is empty or has only 1 observation sometimes</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>  counts <span class="ot">&lt;-</span> <span class="fu">table</span>(test_data<span class="sc">$</span>is_active)</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(counts) <span class="sc">&lt;</span> <span class="dv">2</span> <span class="sc">||</span> <span class="fu">min</span>(counts) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">tibble</span>(</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">event_name =</span> evt_name,</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">t_statistic =</span> <span class="cn">NA</span>,</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">p_value =</span> <span class="cn">NA</span>,</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_with =</span> <span class="cn">NA</span>,</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_without =</span> <span class="cn">NA</span>,</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">note =</span> <span class="st">"Insufficient data"</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run Two-Sided T-Test (assuming unequal variances / Welch's t-test)</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># H0: mean(sales|active) == mean(sales|inactive)</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ha: mean(sales|active) != mean(sales|inactive)</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>  t_res <span class="ot">&lt;-</span> <span class="fu">t.test</span>(total_sales <span class="sc">~</span> is_active, <span class="at">data =</span> test_data, <span class="at">alternative =</span> <span class="st">"two.sided"</span>)</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return row</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_name =</span> evt_name,</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">t_statistic =</span> t_res<span class="sc">$</span>statistic,</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_value =</span> t_res<span class="sc">$</span>p.value,</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_without =</span> t_res<span class="sc">$</span>estimate[<span class="dv">1</span>], <span class="co"># usually group 0</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_with =</span> t_res<span class="sc">$</span>estimate[<span class="dv">2</span>]     <span class="co"># usually group 1</span></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Process and Display Results</span></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------</span></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>final_hypothesis_table <span class="ot">&lt;-</span> hypothesis_results <span class="sc">%&gt;%</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sort by statistical significance (lowest p-value first)</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(p_value) <span class="sc">%&gt;%</span></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format p-values for readability (&lt; 0.001, etc.)</span></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_value_fmt =</span> <span class="fu">ifelse</span>(p_value <span class="sc">&lt;</span> <span class="fl">0.001</span>, <span class="st">"&lt; 0.001"</span>, <span class="fu">round</span>(p_value, <span class="dv">4</span>)),</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">t_statistic =</span> <span class="fu">round</span>(t_statistic, <span class="dv">2</span>),</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_with =</span> <span class="fu">round</span>(mean_with, <span class="dv">1</span>),</span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_without =</span> <span class="fu">round</span>(mean_without, <span class="dv">1</span>),</span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff =</span> mean_with <span class="sc">-</span> mean_without</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(event_name, t_statistic, <span class="at">p_value =</span> p_value_fmt, mean_with, mean_without, diff)</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Display table</span></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(final_hypothesis_table, </span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>             <span class="at">caption =</span> <span class="st">"Hypothesis Test Results: Impact of Events on Daily Sales (Sorted by Significance)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Hypothesis Test Results: Impact of Events on Daily Sales (Sorted by Significance)</caption>
<colgroup>
<col style="width: 28%">
<col style="width: 16%">
<col style="width: 11%">
<col style="width: 14%">
<col style="width: 18%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">event_name</th>
<th style="text-align: right;">t_statistic</th>
<th style="text-align: left;">p_value</th>
<th style="text-align: right;">mean_with</th>
<th style="text-align: right;">mean_without</th>
<th style="text-align: right;">diff</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">christmasday</td>
<td style="text-align: right;">205.58</td>
<td style="text-align: left;">&lt; 0.001</td>
<td style="text-align: right;">2.2</td>
<td style="text-align: right;">1571.0</td>
<td style="text-align: right;">-1568.8</td>
</tr>
<tr class="even">
<td style="text-align: left;">snap_TX</td>
<td style="text-align: right;">-12.35</td>
<td style="text-align: left;">&lt; 0.001</td>
<td style="text-align: right;">1699.2</td>
<td style="text-align: right;">1501.9</td>
<td style="text-align: right;">197.3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">halloween</td>
<td style="text-align: right;">6.24</td>
<td style="text-align: left;">&lt; 0.001</td>
<td style="text-align: right;">1311.7</td>
<td style="text-align: right;">1569.6</td>
<td style="text-align: right;">-257.9</td>
</tr>
<tr class="even">
<td style="text-align: left;">columbusday</td>
<td style="text-align: right;">-5.89</td>
<td style="text-align: left;">&lt; 0.001</td>
<td style="text-align: right;">1823.6</td>
<td style="text-align: right;">1564.2</td>
<td style="text-align: right;">259.4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">laborday</td>
<td style="text-align: right;">-5.20</td>
<td style="text-align: left;">&lt; 0.001</td>
<td style="text-align: right;">1933.0</td>
<td style="text-align: right;">1563.0</td>
<td style="text-align: right;">370.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">independenceday</td>
<td style="text-align: right;">-5.09</td>
<td style="text-align: left;">&lt; 0.001</td>
<td style="text-align: right;">1835.8</td>
<td style="text-align: right;">1564.0</td>
<td style="text-align: right;">271.8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fathersday</td>
<td style="text-align: right;">-3.68</td>
<td style="text-align: left;">0.0015</td>
<td style="text-align: right;">1854.8</td>
<td style="text-align: right;">1563.8</td>
<td style="text-align: right;">291.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">easter</td>
<td style="text-align: right;">-3.00</td>
<td style="text-align: left;">0.0063</td>
<td style="text-align: right;">1807.6</td>
<td style="text-align: right;">1563.8</td>
<td style="text-align: right;">243.8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">eidalfitr</td>
<td style="text-align: right;">-2.94</td>
<td style="text-align: left;">0.0082</td>
<td style="text-align: right;">1784.2</td>
<td style="text-align: right;">1564.6</td>
<td style="text-align: right;">219.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">newyear</td>
<td style="text-align: right;">2.06</td>
<td style="text-align: left;">0.0532</td>
<td style="text-align: right;">1428.2</td>
<td style="text-align: right;">1568.4</td>
<td style="text-align: right;">-140.2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">chanukahend</td>
<td style="text-align: right;">1.82</td>
<td style="text-align: left;">0.0843</td>
<td style="text-align: right;">1409.8</td>
<td style="text-align: right;">1568.5</td>
<td style="text-align: right;">-158.7</td>
</tr>
<tr class="even">
<td style="text-align: left;">presidentsday</td>
<td style="text-align: right;">-1.68</td>
<td style="text-align: left;">0.1068</td>
<td style="text-align: right;">1659.0</td>
<td style="text-align: right;">1565.7</td>
<td style="text-align: right;">93.3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nbafinalsend</td>
<td style="text-align: right;">-1.53</td>
<td style="text-align: left;">0.1413</td>
<td style="text-align: right;">1792.0</td>
<td style="text-align: right;">1564.5</td>
<td style="text-align: right;">227.5</td>
</tr>
<tr class="even">
<td style="text-align: left;">superbowl</td>
<td style="text-align: right;">-1.31</td>
<td style="text-align: left;">0.2016</td>
<td style="text-align: right;">1676.1</td>
<td style="text-align: right;">1565.5</td>
<td style="text-align: right;">110.6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">memorialday</td>
<td style="text-align: right;">-1.31</td>
<td style="text-align: left;">0.2039</td>
<td style="text-align: right;">1640.3</td>
<td style="text-align: right;">1566.1</td>
<td style="text-align: right;">74.2</td>
</tr>
<tr class="even">
<td style="text-align: left;">orthodoxeaster</td>
<td style="text-align: right;">-1.11</td>
<td style="text-align: left;">0.2816</td>
<td style="text-align: right;">1659.4</td>
<td style="text-align: right;">1565.9</td>
<td style="text-align: right;">93.5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lentstart</td>
<td style="text-align: right;">1.06</td>
<td style="text-align: left;">0.2979</td>
<td style="text-align: right;">1493.9</td>
<td style="text-align: right;">1567.8</td>
<td style="text-align: right;">-73.9</td>
</tr>
<tr class="even">
<td style="text-align: left;">nbafinalsstart</td>
<td style="text-align: right;">-0.99</td>
<td style="text-align: left;">0.333</td>
<td style="text-align: right;">1641.0</td>
<td style="text-align: right;">1566.1</td>
<td style="text-align: right;">74.9</td>
</tr>
<tr class="odd">
<td style="text-align: left;">stpatricksday</td>
<td style="text-align: right;">-0.89</td>
<td style="text-align: left;">0.3798</td>
<td style="text-align: right;">1615.9</td>
<td style="text-align: right;">1566.3</td>
<td style="text-align: right;">49.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">thanksgiving</td>
<td style="text-align: right;">0.88</td>
<td style="text-align: left;">0.3895</td>
<td style="text-align: right;">1509.8</td>
<td style="text-align: right;">1567.5</td>
<td style="text-align: right;">-57.7</td>
</tr>
<tr class="odd">
<td style="text-align: left;">valentinesday</td>
<td style="text-align: right;">-0.85</td>
<td style="text-align: left;">0.4044</td>
<td style="text-align: right;">1621.6</td>
<td style="text-align: right;">1566.2</td>
<td style="text-align: right;">55.4</td>
</tr>
<tr class="even">
<td style="text-align: left;">ramadanstarts</td>
<td style="text-align: right;">-0.78</td>
<td style="text-align: left;">0.4447</td>
<td style="text-align: right;">1676.9</td>
<td style="text-align: right;">1565.7</td>
<td style="text-align: right;">111.2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mothersday</td>
<td style="text-align: right;">-0.74</td>
<td style="text-align: left;">0.469</td>
<td style="text-align: right;">1631.8</td>
<td style="text-align: right;">1566.2</td>
<td style="text-align: right;">65.6</td>
</tr>
<tr class="even">
<td style="text-align: left;">purimend</td>
<td style="text-align: right;">0.71</td>
<td style="text-align: left;">0.4842</td>
<td style="text-align: right;">1530.9</td>
<td style="text-align: right;">1567.3</td>
<td style="text-align: right;">-36.4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">martinlutherkingday</td>
<td style="text-align: right;">-0.57</td>
<td style="text-align: left;">0.5748</td>
<td style="text-align: right;">1593.8</td>
<td style="text-align: right;">1566.6</td>
<td style="text-align: right;">27.2</td>
</tr>
<tr class="even">
<td style="text-align: left;">veteransday</td>
<td style="text-align: right;">0.49</td>
<td style="text-align: left;">0.6297</td>
<td style="text-align: right;">1540.7</td>
<td style="text-align: right;">1567.2</td>
<td style="text-align: right;">-26.5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pesachend</td>
<td style="text-align: right;">-0.45</td>
<td style="text-align: left;">0.656</td>
<td style="text-align: right;">1604.4</td>
<td style="text-align: right;">1566.5</td>
<td style="text-align: right;">37.9</td>
</tr>
<tr class="even">
<td style="text-align: left;">christmaspre</td>
<td style="text-align: right;">-0.41</td>
<td style="text-align: left;">0.6859</td>
<td style="text-align: right;">1590.9</td>
<td style="text-align: right;">1566.7</td>
<td style="text-align: right;">24.2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">orthodoxchristmas</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: left;">0.7169</td>
<td style="text-align: right;">1549.0</td>
<td style="text-align: right;">1567.1</td>
<td style="text-align: right;">-18.1</td>
</tr>
<tr class="even">
<td style="text-align: left;">lentweek2</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: left;">0.7474</td>
<td style="text-align: right;">1543.6</td>
<td style="text-align: right;">1567.2</td>
<td style="text-align: right;">-23.6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cincodemayo</td>
<td style="text-align: right;">-0.05</td>
<td style="text-align: left;">0.9627</td>
<td style="text-align: right;">1571.9</td>
<td style="text-align: right;">1566.8</td>
<td style="text-align: right;">5.1</td>
</tr>
<tr class="even">
<td style="text-align: left;">eidaladha</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: left;">0.9959</td>
<td style="text-align: right;">1566.6</td>
<td style="text-align: right;">1566.9</td>
<td style="text-align: right;">-0.3</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="dynamic-harmonic-regression-modeling" class="level2">
<h2 class="anchored" data-anchor-id="dynamic-harmonic-regression-modeling">10. Dynamic Harmonic Regression Modeling</h2>
<p>We now proceed to fit Dynamic Harmonic Regression models. We use <strong>Fourier terms</strong> to capture the annual seasonality (<span class="math inline">\(period = "year"\)</span>) because the data is daily. We test three levels of complexity for the seasonal shape: * <strong><span class="math inline">\(K=1\)</span></strong>: Smooth, sine-wave-like annual pattern. * <strong><span class="math inline">\(K=5\)</span></strong>: Moderate complexity, capturing broader seasonal shifts. * <strong><span class="math inline">\(K=10\)</span></strong>: High complexity, capturing sharper seasonal peaks.</p>
<p>For each <span class="math inline">\(K\)</span>, we test four predictor configurations: 1. <strong>Base</strong>: Fourier terms only. 2. <strong>Price</strong>: Fourier + <code>sell_price</code>. 3. <strong>Events</strong>: Fourier + Significant Events (<code>snap_TX</code>, <code>halloween</code>, etc.). 4. <strong>Full</strong>: Fourier + <code>sell_price</code> + Significant Events.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fable)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tsibble)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 0. Data Overview</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Assumes 'product_tsibble' is already loaded in your environment</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Processing ALL"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(product_tsibble<span class="sc">$</span>id)), <span class="st">"products."</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Processing ALL 823 products."</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Define Predictors &amp; Helper</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>sig_events <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"snap_TX"</span>, <span class="st">"halloween"</span>, <span class="st">"columbusday"</span>, <span class="st">"laborday"</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                <span class="st">"independenceday"</span>, <span class="st">"fathersday"</span>, <span class="st">"easter"</span>, <span class="st">"eidalfitr"</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>build_harmonic_formula <span class="ot">&lt;-</span> <span class="cf">function</span>(K, <span class="at">include_price =</span> <span class="cn">FALSE</span>, <span class="at">include_events =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  rhs <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"fourier(period = 'year', K = "</span>, K, <span class="st">")"</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(include_price) rhs <span class="ot">&lt;-</span> <span class="fu">paste</span>(rhs, <span class="st">"+ sell_price"</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(include_events) {</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    events_string <span class="ot">&lt;-</span> <span class="fu">paste</span>(sig_events, <span class="at">collapse =</span> <span class="st">" + "</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    rhs <span class="ot">&lt;-</span> <span class="fu">paste</span>(rhs, <span class="st">"+"</span>, events_string)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"sales_volume ~"</span>, rhs))</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Fit The "Horse Race" Models (ON ALL DATA)</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Warning: This step may take significant time/memory depending on dataset size</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>robust_models <span class="ot">&lt;-</span> product_tsibble <span class="sc">%&gt;%</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">arima_complex =</span> <span class="fu">ARIMA</span>(<span class="sc">!!</span><span class="fu">build_harmonic_formula</span>(<span class="at">K=</span><span class="dv">3</span>, <span class="at">include_price=</span><span class="cn">TRUE</span>, <span class="at">include_events=</span><span class="cn">TRUE</span>)),</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">croston =</span> <span class="fu">CROSTON</span>(sales_volume),</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">snaive =</span> <span class="fu">SNAIVE</span>(sales_volume <span class="sc">~</span> <span class="fu">lag</span>(<span class="st">"year"</span>))</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Models fitted on all products. Moving to forecast phase..."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Models fitted on all products. Moving to forecast phase..."</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># LOAD EXTERNAL DATA</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Prices</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>prices_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/sell_prices_afcs2025.csv"</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Validation Data</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>validation_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/sales_test_validation_afcs2025.csv"</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure Calendar is loaded</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"calendar"</span>)) {</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  calendar <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/calendar_afcs2025.csv"</span>)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Prepare Validation Set (ALL PRODUCTS)</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>validation_ts <span class="ot">&lt;-</span> validation_raw <span class="sc">%&gt;%</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"d_"</span>), <span class="at">names_to =</span> <span class="st">"d"</span>, <span class="at">values_to =</span> <span class="st">"sales_volume"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">item_id =</span> <span class="fu">str_sub</span>(id, <span class="dv">1</span>, <span class="dv">11</span>),</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">store_id =</span> <span class="fu">str_remove</span>(<span class="fu">str_sub</span>(id, <span class="dv">13</span>, <span class="fu">nchar</span>(id)), <span class="st">"_validation"</span>)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calendar, <span class="at">by =</span> <span class="st">"d"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, date, sales_volume) <span class="sc">%&gt;%</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, date) <span class="sc">%&gt;%</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">key =</span> id, <span class="at">index =</span> date)</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Removed filter(id %in% selected_ids)</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Prepare Future Regressors</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Using product_tsibble (all data) instead of subset</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>future_scenarios <span class="ot">&lt;-</span> <span class="fu">new_data</span>(product_tsibble, <span class="at">n =</span> <span class="dv">28</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calendar, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">item_id =</span> <span class="fu">str_sub</span>(id, <span class="dv">1</span>, <span class="dv">11</span>),</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">store_id =</span> <span class="fu">str_remove</span>(<span class="fu">str_sub</span>(id, <span class="dv">13</span>, <span class="fu">nchar</span>(id)), <span class="st">"_validation"</span>)</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(prices_raw, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"store_id"</span>, <span class="st">"item_id"</span>, <span class="st">"wm_yr_wk"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fill</span>(sell_price, <span class="at">.direction =</span> <span class="st">"downup"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Generate Forecasts</span></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>forecasts <span class="ot">&lt;-</span> robust_models <span class="sc">%&gt;%</span></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">forecast</span>(<span class="at">new_data =</span> future_scenarios)</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Race Results: Who Won? (Compute RMSE)</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------</span></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>accuracy_results <span class="ot">&lt;-</span> forecasts <span class="sc">%&gt;%</span></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">accuracy</span>(validation_ts, <span class="at">measures =</span> <span class="fu">list</span>(<span class="at">RMSE =</span> RMSE))</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Select the Winner Per Product</span></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------</span></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>best_model_per_product <span class="ot">&lt;-</span> accuracy_results <span class="sc">%&gt;%</span></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(RMSE <span class="sc">==</span> <span class="fu">min</span>(RMSE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, .model, RMSE)</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Create Final Submission</span></span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------</span></span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>final_submission <span class="ot">&lt;-</span> forecasts <span class="sc">%&gt;%</span></span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(best_model_per_product, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">".model"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, date, .mean) <span class="sc">%&gt;%</span></span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">forecast =</span> .mean)</span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Winning Model Counts:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Winning Model Counts:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">table</span>(best_model_per_product<span class="sc">$</span>.model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
croston  snaive 
    778      45 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Preview of Final Forecasts:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Preview of Final Forecasts:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(final_submission))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  id                          date       forecast
  &lt;chr&gt;                       &lt;date&gt;        &lt;dbl&gt;
1 FOODS_3_001_TX_3_validation 2016-04-25    0.389
2 FOODS_3_001_TX_3_validation 2016-04-26    0.389
3 FOODS_3_001_TX_3_validation 2016-04-27    0.389
4 FOODS_3_001_TX_3_validation 2016-04-28    0.389
5 FOODS_3_001_TX_3_validation 2016-04-29    0.389
6 FOODS_3_001_TX_3_validation 2016-04-30    0.389</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Identify Products with &gt; 75% Non-Zero Sales</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>high_velocity_ids <span class="ot">&lt;-</span> product_tsibble <span class="sc">%&gt;%</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_total =</span> <span class="fu">n</span>(),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_nonzero =</span> <span class="fu">sum</span>(sales_volume <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">nonzero_pct =</span> n_nonzero <span class="sc">/</span> n_total</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(nonzero_pct <span class="sc">&gt;</span> <span class="fl">0.75</span>) <span class="sc">%&gt;%</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Found"</span>, <span class="fu">length</span>(high_velocity_ids), <span class="st">"products with &gt; 75% non-zero sales."</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Found 74 products with &gt; 75% non-zero sales."</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Select One Specific Product</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We pick the first one found, or sample one if you prefer</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>target_id <span class="ot">&lt;-</span> high_velocity_ids[<span class="dv">1</span>]</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Visualizing Product:"</span>, target_id))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Visualizing Product: FOODS_3_030_TX_3_validation"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Retrieve Winner &amp; Plot</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the name of the winning model for this specific ID</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>target_winner_name <span class="ot">&lt;-</span> best_model_per_product <span class="sc">%&gt;%</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> target_id) <span class="sc">%&gt;%</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.model)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Winning Model for this product:"</span>, target_winner_name))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Winning Model for this product: croston"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter forecasts for this specific ID and the winning model</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>target_forecast <span class="ot">&lt;-</span> forecasts <span class="sc">%&gt;%</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> target_id, .model <span class="sc">==</span> target_winner_name)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter actual validation data for this specific ID</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>target_actuals <span class="ot">&lt;-</span> validation_ts <span class="sc">%&gt;%</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> target_id)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Generate the Plot</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>target_forecast <span class="sc">%&gt;%</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(target_actuals) <span class="sc">+</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Forecast vs Actuals:"</span>, target_id),</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Winning Model:"</span>, target_winner_name, <span class="st">"| Data: Validation Set"</span>),</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Sales Volume"</span>,</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dynamic_regression_pipeline_files/figure-html/select_product_for_winner-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(feasts)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Isolate the specific winning model object (mable)</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>target_mable <span class="ot">&lt;-</span> robust_models <span class="sc">%&gt;%</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">==</span> target_id) <span class="sc">%&gt;%</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, <span class="sc">!!</span><span class="fu">sym</span>(target_winner_name))</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Plot Residuals</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="co"># This shows the Innovation Residuals, ACF, and Distribution</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>target_mable <span class="sc">%&gt;%</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gg_tsresiduals</span>() <span class="sc">+</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Residual Diagnostics:"</span>, target_id, <span class="st">"("</span>, target_winner_name, <span class="st">")"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="dynamic_regression_pipeline_files/figure-html/select_product_for_winner-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Extract residuals for the target product</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>target_residuals <span class="ot">&lt;-</span> target_mable <span class="sc">%&gt;%</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">augment</span>() <span class="sc">%&gt;%</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Find the top 10 largest misses (absolute error)</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------------------------</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>top_10_misses <span class="ot">&lt;-</span> target_residuals <span class="sc">%&gt;%</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">abs_residual =</span> <span class="fu">abs</span>(.innov)) <span class="sc">%&gt;%</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(abs_residual)) <span class="sc">%&gt;%</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, date, .innov, sales_volume) <span class="sc">%&gt;%</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">residual =</span> .innov, <span class="at">actual_sales =</span> sales_volume)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Top 10 Dates with Highest Residuals:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Top 10 Dates with Highest Residuals:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(top_10_misses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
   id                          date       residual actual_sales
   &lt;chr&gt;                       &lt;date&gt;        &lt;dbl&gt;        &lt;dbl&gt;
 1 FOODS_3_030_TX_3_validation 2013-12-25   -142.             0
 2 FOODS_3_030_TX_3_validation 2014-01-31    141.           246
 3 FOODS_3_030_TX_3_validation 2013-11-27    121.           213
 4 FOODS_3_030_TX_3_validation 2014-02-01    117.           320
 5 FOODS_3_030_TX_3_validation 2014-02-06   -109.             6
 6 FOODS_3_030_TX_3_validation 2013-11-28    -97.5           78
 7 FOODS_3_030_TX_3_validation 2011-02-12     85.9           90
 8 FOODS_3_030_TX_3_validation 2013-08-01     84.6          162
 9 FOODS_3_030_TX_3_validation 2013-12-24     83.0          172
10 FOODS_3_030_TX_3_validation 2013-12-30     81.9          189</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>top_10_with_context <span class="ot">&lt;-</span> top_10_misses <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calendar, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, residual, actual_sales, event_name_1, snap_TX)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(top_10_with_context)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   date       residual actual_sales event_name_1 snap_TX
   &lt;date&gt;        &lt;dbl&gt;        &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;
 1 2013-12-25   -142.             0 Christmas          0
 2 2014-01-31    141.           246 &lt;NA&gt;               0
 3 2013-11-27    121.           213 &lt;NA&gt;               0
 4 2014-02-01    117.           320 &lt;NA&gt;               1
 5 2014-02-06   -109.             6 &lt;NA&gt;               1
 6 2013-11-28    -97.5           78 Thanksgiving       0
 7 2011-02-12     85.9           90 &lt;NA&gt;               1
 8 2013-08-01     84.6          162 &lt;NA&gt;               1
 9 2013-12-24     83.0          172 &lt;NA&gt;               0
10 2013-12-30     81.9          189 &lt;NA&gt;               0</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>